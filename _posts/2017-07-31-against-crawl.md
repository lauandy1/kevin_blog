---
layout: post
title: 防抓取策略
author: andy
tags:  security
categories:  security
excerpt: 防抓取策略
---

* TOC
{:toc}

# 场景

目的：防止从自增ID中明显看出我们的数据量，防止根据ID自增规则抓取全量的拍品数据。防止用户通过拼接拍品ID生成请求URL，定时爬取全量拍品数据，造成数据损失同时给服务器带来很大压力。
策略：随机ID + 认证访问

# 随机ID策略

    保持现有拍品ID类型为数字，字段名称不变为前提，考虑到过去6年总量165万。拍品ID使用20000000 - 90000000之间随机数。
    由java提供唯一随机ID生成服务，拍品生成时调用服务获取拍品ID。
    考虑到有一键发拍情况，ID服务可以一次性指生成最多200个ID，一次性调用接口返回。
    从ID服务获取到一个唯一随机ID后，此ID一定不会再被获取到。
    SQL Server不支持在自增长字段指定插入某个值，所以需要字段修改为非自增长，和程序同步上线。

# 认证访问

    在列表页的拍品链接里，添加校验参数_tk，传递给详情页时进行此_tk参数校验。列表页生成的参数和详情页同样算法生成参数相同时，校验通过正常显示拍品报告，校验不通过直接返回拒绝访问，不再往下执行程序以防止数据被抓取同时减少服务器压力。
    拍品详情页URL规则：http://www.youxinpai.com/trade/detail/拍品id/_tk校验值/，比如：http://www.youxinpai.com/trade/detail/1600001/aefd72/
    其中_tk校验值由java接口提供。验证在node.js端实现。
    加密校验算法：str=md5(拍品ID + 日期 + 私钥) ，然后从md5加密串str里取第20、17、0、6、1、5位字符，拼接成6位字符，日期为避免每天凌晨00:00服务器时间不同步产生认证失败问题，在接收端计算时间时，前后兼容1小时。即 md5(拍品ID + 获取日期(当前时间加1小时) + 私钥)和md5(拍品ID + 获取日期(当前时间减1小时) + 私钥)都可以认证通过。
    私钥 letmeseepp
